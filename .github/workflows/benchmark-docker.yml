name: Docker Benchmark

on:
  workflow_dispatch:
    inputs:
      bench_duration:
        description: 'Benchmark duration in seconds'
        required: false
        default: '60'

jobs:
  run-benchmark:
    name: Run Benchmark in Docker
    # Use self-hosted runner on your Google machine
    # Add more labels if needed, e.g., [self-hosted, linux, google-cloud]
    runs-on: [self-hosted, linux]
    timeout-minutes: 60

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build Docker Image
      run: |
        docker build \
          -f docker/bench/Dockerfile \
          -t gravity-bench:latest \
          .

    - name: Run Benchmark Container
      run: |
        docker run --rm \
          --name gravity-bench-run \
          -e BENCH_DURATION_SECONDS=${{ github.event.inputs.bench_duration }} \
          gravity-bench:latest | tee benchmark_output.log

    - name: Verify Benchmark Results
      run: |
        python3 scripts/verify_benchmark.py benchmark_output.log

    - name: Cleanup Docker Image (Optional)
      if: always()
      run: |
        docker rmi gravity-bench:latest || true
