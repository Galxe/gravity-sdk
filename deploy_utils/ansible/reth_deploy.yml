- name: Deploy and start Reth on servers
  hosts: reth_servers
  vars:
    log_collection: []
  tasks:
    - name: Pull and checkout code
      shell: |
        git pull && git checkout {{ tag_or_brach }}"
      async: 600
      poll: 30
      args:
        chdir: "{{ reth_root_dir }}"
      register: git_log
    - name: Append git logs to collection
      set_fact:
        log_collection: "{{ log_collection + [git_log] }}"

    - name: Compile Reth with custom options
      shell: |
        bash -c ". "$HOME/.cargo/env" && make {{ reth_compile_options }}"
      async: 600
      poll: 30
      args:
        chdir: "{{ reth_root_dir }}"
      register: compile_log
    - name: Append compile logs to collection
      set_fact:
        log_collection: "{{ log_collection + [compile_log] }}"

    - name: Start Reth service using script
      shell: |
        bash deploy_utils/deploy.sh {{ reth_node_arg }}
      async: 30
      poll: 5
      args:
        chdir: "{{ reth_root_dir }}"
      register: deploy_service_log
    - name: Append service start logs to collection
      set_fact:
        log_collection: "{{ log_collection + [deploy_service_log] }}"

    - name: Copy nodes config to remote
      copy:
        src: ./server_confs/nodes_config.json
        dest: "/tmp/{{ reth_node_id }}/genesis/nodes_config.json"

    - name: Copy nodes discover to remote
      copy:
        src: ./server_confs/discovery
        dest: "/tmp/{{ reth_node_id }}/discovery"

    - name: Copy validator conf to remote
      copy:
        src: "./server_confs/{{ reth_node_id }}/genesis/validator.yaml"
        dest: "/tmp/{{ reth_node_id }}/genesis/validator.yaml"
    
    - name: Copy start bash to remote
      copy:
        src: "../start.sh"
        dest: "/tmp/{{ reth_node_id }}/script"

    - name: Start Reth service using script
      shell: |
        {{ reth_env }} bash start.sh --node {{ reth_node_id }}
      args:
        chdir: "/tmp/{{ reth_node_id }}/script"
      async: 30
      poll: 5
      register: deploy_service_log
    - name: Append service start logs to collection
      set_fact:
        log_collection: "{{ log_collection + [deploy_service_log] }}"

    - name: Output collected logs
      debug:
        msg: "{{ item.stdout | default('') }}"
      with_items: "{{ log_collection }}"
