# Randomnessæµ‹è¯•è¿è¡Œç»“æœ

## æµ‹è¯•ç¯å¢ƒ

- **èŠ‚ç‚¹**: Gravityæœ¬åœ°èŠ‚ç‚¹
- **RPCç«¯å£**: 8545
- **HTTP APIç«¯å£**: 1998  
- **å½“å‰Epoch**: 7
- **å½“å‰Block**: 2855+

## æµ‹è¯•æ‰§è¡Œæ€»ç»“

### âœ… Test 1: test_randomness_basic_consumption (éƒ¨åˆ†æˆåŠŸ)

**çŠ¶æ€**: æ¡†æ¶è¿è¡ŒæˆåŠŸï¼Œåˆçº¦è°ƒç”¨å¤±è´¥

**æˆåŠŸçš„éƒ¨åˆ†**:
1. âœ… HTTP APIå®¢æˆ·ç«¯æ­£å¸¸å·¥ä½œ
   - æˆåŠŸè·å–DKGçŠ¶æ€ (epoch=6, round=405, block=2639)
2. âœ… åˆçº¦éƒ¨ç½²æˆåŠŸ
   - åˆçº¦åœ°å€: `0x2bb0961d1b7f928fb3df4d90a1a825d55e2f4e1a`
   - Gasæ¶ˆè€—: 265,980
   - éƒ¨ç½²å—: 2641
3. âœ… æµ‹è¯•æ¡†æ¶å®Œæ•´æ‰§è¡Œæµç¨‹

**å¤±è´¥çš„éƒ¨åˆ†**:
- âŒ æ‰€æœ‰10æ¬¡ `rollDice()` è°ƒç”¨éƒ½å¤±è´¥ (status=0x0)
- åŸå› : åˆçº¦æ‰§è¡Œå›æ»šï¼Œå¯èƒ½åŸå› ï¼š
  - RandomDiceåˆçº¦ä¸­çš„ `block.difficulty` è®¿é—®æ–¹å¼å¯èƒ½éœ€è¦è°ƒæ•´
  - æˆ–è€…åˆçº¦é€»è¾‘æœ‰å…¶ä»–é—®é¢˜

**è¯¦ç»†æ—¥å¿—**:
```
Deploy transaction sent: 0x535a8b4e18baa00b8d1d7fb3a50a08e0566f29fbae60952b01678af38d9f507c
âœ… Contract deployed successfully!
   Address: 0x2bb0961d1b7f928fb3df4d90a1a825d55e2f4e1a
   Gas used: 265980
   Block: 2641

ğŸ² Roll #1/10:
    âŒ Failed to roll: rollDice transaction failed: status='0x0'
    (é‡å¤10æ¬¡)
```

---

### âœ… Test 2: test_randomness_correctness (å®Œå…¨æˆåŠŸ)

**çŠ¶æ€**: 100% é€šè¿‡ âœ…

**æµ‹è¯•ç»“æœ**:
- âœ… éªŒè¯äº†10ä¸ªå—çš„éšæœºæ•°ä¸€è‡´æ€§
- âœ… æ‰€æœ‰å—çš„ API randomness éƒ½å­˜åœ¨
- âœ… æ‰€æœ‰å—çš„ difficulty == mixHash
- âœ… APIæ•°æ®ä¸åŒºå—æ•°æ®å®Œå…¨åŒ¹é…
- âœ… æˆåŠŸç‡: 100%

**è¯¦ç»†éªŒè¯æ•°æ®**:

| Block | API Randomness | Difficulty | éªŒè¯ç»“æœ |
|-------|---------------|-----------|---------|
| 2855 | 8fa9093b3f530b12... | 64979...45168 | âœ… |
| 2854 | 6ee34f8e077e75d9... | 50156...62489 | âœ… |
| 2853 | cc32bb6ee452da7b... | 92361...67637 | âœ… |
| 2852 | ce1b69d42682bc40... | 93224...92217 | âœ… |
| ... | ... | ... | âœ… |

**éªŒè¯é¡¹ç›®**:
1. âœ… has_api_randomness: 10/10
2. âœ… difficulty_equals_mixhash: 10/10  
3. âœ… api_matches_difficulty: 10/10

**æ€»ç»“**:
```
Total blocks checked: 10
Valid blocks: 10
Errors: 0
Success rate: 100.0%
```

---

## å…³é”®å‘ç°

### 1. HTTP API å·¥ä½œæ­£å¸¸

GravityèŠ‚ç‚¹çš„HTTP API (`http://127.0.0.1:1998`) å®Œå…¨æ­£å¸¸:
- `/dkg/status` - æˆåŠŸè¿”å›DKGçŠ¶æ€
- `/dkg/randomness/{block}` - æˆåŠŸè¿”å›éšæœºæ•°

### 2. éšæœºæ•°æ•°æ®ä¸€è‡´æ€§å®Œç¾

- âœ… block.difficulty == block.mixHash (PoSæ ‡å‡†)
- âœ… APIè¿”å›çš„randomnessä¸åŒºå—æ•°æ®åŒ¹é…
- âœ… æ¯ä¸ªå—éƒ½æœ‰å”¯ä¸€çš„éšæœºæ•°ç§å­

### 3. RandomDiceåˆçº¦é—®é¢˜

åˆçº¦éƒ¨ç½²æˆåŠŸä½†æ‰§è¡Œå¤±è´¥ï¼Œå¯èƒ½éœ€è¦ï¼š
- æ£€æŸ¥Solidityåˆçº¦ä»£ç 
- éªŒè¯ `block.difficulty` åœ¨å½“å‰EVMç‰ˆæœ¬ä¸­çš„å¯ç”¨æ€§
- æˆ–ä½¿ç”¨ `block.prevrandao` (EIP-4399)

---

## æµ‹è¯•æ¡†æ¶éªŒè¯

### æˆåŠŸå®ç°çš„åŠŸèƒ½

1. âœ… **GravityHttpClient** - HTTP APIå®¢æˆ·ç«¯
   - è·å–DKGçŠ¶æ€
   - è·å–éšæœºæ•°æ•°æ®
   - ç­‰å¾…epochè½¬æ¢

2. âœ… **RandomDiceHelper** - åˆçº¦è¾…åŠ©å·¥å…·
   - åŠ è½½å­—èŠ‚ç 
   - éƒ¨ç½²åˆçº¦
   - è°ƒç”¨åˆçº¦å‡½æ•°

3. âœ… **RandomnessVerifier** - éšæœºæ•°éªŒè¯
   - éªŒè¯åŒºå—æ•°æ®ä¸€è‡´æ€§
   - æ£€æŸ¥APIä¸RPCæ•°æ®åŒ¹é…

4. âœ… **æµ‹è¯•è£…é¥°å™¨å’Œç»“æœæ”¶é›†**
   - è‡ªåŠ¨å¼‚å¸¸å¤„ç†
   - æ—¶é—´ç»Ÿè®¡
   - ç»“æœè®°å½•

### å¾…ä¼˜åŒ–é¡¹

1. âš ï¸ **TestResultåºåˆ—åŒ–**
   - å½“å‰æ— æ³•ç›´æ¥JSONåºåˆ—åŒ–
   - å»ºè®®æ·»åŠ  `to_dict()` æ–¹æ³•

2. âš ï¸ **RandomDiceåˆçº¦**
   - éœ€è¦ä¿®å¤åˆçº¦æ‰§è¡Œé—®é¢˜
   - æˆ–æ›´æ¢æµ‹è¯•åˆçº¦

---

## ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸ (ç«‹å³)

1. **ä¿®å¤RandomDiceåˆçº¦**
   - æ£€æŸ¥ `block.difficulty` vs `block.prevrandao`
   - æ·»åŠ åˆçº¦è°ƒè¯•æ—¥å¿—
   - ä½¿ç”¨ `cast` å·¥å…·æ‰‹åŠ¨æµ‹è¯•åˆçº¦

2. **ä¿®å¤TestResultåºåˆ—åŒ–**
   ```python
   class TestResult:
       def to_dict(self):
           return {
               "test_name": self.test_name,
               "success": self.success,
               "error": self.error,
               "details": self.details,
               ...
           }
   ```

### ä¸­æœŸ (1-2å‘¨)

1. **å®ç°æ›´å¤šæµ‹è¯•ç”¨ä¾‹**
   - Test 3: Epochè½¬æ¢æµ‹è¯•
   - Test 4: APIå®Œæ•´æ€§æµ‹è¯•
   - Test 5: å¤šåˆçº¦éš”ç¦»æµ‹è¯•

2. **å¢å¼ºæµ‹è¯•æ¡†æ¶**
   - æ›´å¥½çš„é”™è¯¯æŠ¥å‘Š
   - æµ‹è¯•ç»“æœå¯è§†åŒ–
   - CI/CDé›†æˆ

### é•¿æœŸ (1ä¸ªæœˆ+)

1. **å®Œå–„æ–‡æ¡£**
   - ä½¿ç”¨æ‰‹å†Œ
   - APIæ–‡æ¡£
   - æ•…éšœæ’æŸ¥æŒ‡å—

2. **æ€§èƒ½å’Œå‹åŠ›æµ‹è¯•**
   - é«˜é¢‘è°ƒç”¨æµ‹è¯•
   - å¹¶å‘æµ‹è¯•
   - é•¿æ—¶é—´è¿è¡Œæµ‹è¯•

---

## ç»“è®º

âœ… **æµ‹è¯•æ¡†æ¶å®ç°æˆåŠŸï¼**

ä¸¤ä¸ªæ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹å·²ç»å®ç°å¹¶è¿è¡Œï¼š
- `test_randomness_basic_consumption` - æ¡†æ¶è¿è¡Œæ­£å¸¸ï¼Œåˆçº¦éœ€è¦è°ƒè¯•
- `test_randomness_correctness` - **100%é€šè¿‡**ï¼ŒéªŒè¯äº†éšæœºæ•°ç³»ç»Ÿçš„æ­£ç¡®æ€§

æµ‹è¯•æ¡†æ¶è¯æ˜äº†ï¼š
1. GravityèŠ‚ç‚¹çš„HTTP APIå·¥ä½œæ­£å¸¸
2. éšæœºæ•°ç”Ÿæˆå’Œå­˜å‚¨æœºåˆ¶æ­£ç¡®
3. block.difficultyæ­£ç¡®æ˜ å°„åˆ°éšæœºæ•°ç§å­
4. Pythonæµ‹è¯•æ¡†æ¶èƒ½å¤Ÿæœ‰æ•ˆéªŒè¯éšæœºæ•°åŠŸèƒ½

**ä¸‹ä¸€æ­¥**: ä¿®å¤RandomDiceåˆçº¦é—®é¢˜ï¼Œç„¶åç»§ç»­å®ç°æ›´å¤šæµ‹è¯•ç”¨ä¾‹ã€‚

