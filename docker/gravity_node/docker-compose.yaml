# Gravity Node 单节点 Docker Compose 配置
#
# 使用方法:
#   构建镜像:  docker-compose build
#   启动节点:  docker-compose up -d
#   查看日志:  docker-compose logs -f
#   停止节点:  docker-compose down
#   清理数据:  docker-compose down -v
#
# 使用外部配置:
#   CONFIG_DIR=../../deploy_utils/node1/config docker-compose up -d
#
# 环境变量:
#   BUILD_TYPE: debug 或 release (默认: release)
#   RUST_LOG: 日志级别 (默认: info)
#   CONFIG_DIR: 配置目录路径 (默认: 使用镜像内置配置)

version: '3.8'

services:
  gravity_node:
    build:
      context: ../..
      dockerfile: docker/gravity_node/validator.Dockerfile
      args:
        BUILD_TYPE: ${BUILD_TYPE:-quick-release}
        RUST_LOG: ${RUST_LOG:-info}
    image: gravity_node:${IMAGE_TAG:-latest}
    container_name: ${CONTAINER_NAME:-gravity_node}
    hostname: ${CONTAINER_NAME:-gravity_node}
    restart: unless-stopped
    
    # 环境变量
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=${RUST_LOG:-info}
      - BATCH_INSERT_TIME=${BATCH_INSERT_TIME:-20}
      - NODE_ID=${NODE_ID:-node0}
    
    # 数据卷
    volumes:
      # 持久化数据
      - ${DATA_DIR:-gravity_data}:/gravity_node/data
      # 日志目录
      - ${LOGS_DIR:-gravity_logs}:/gravity_node/logs
      - ${EXEC_LOGS_DIR:-gravity_exec_logs}:/gravity_node/execution_logs
      # 共识日志
      - ${CONSENSUS_LOG:-gravity_consensus_log}:/gravity_node/consensus_log
      # 外部配置目录 (如果指定 CONFIG_DIR)
      - ${CONFIG_DIR:-./config}:/gravity_node/config:ro
    
    # 端口映射
    ports:
      - "${RPC_PORT:-8545}:8545"           # RPC HTTP
      - "${AUTH_RPC_PORT:-8551}:8551"      # Auth RPC
      - "${METRICS_PORT:-9001}:9001"       # Metrics
      - "${RETH_P2P_PORT:-12024}:12024"    # Reth P2P
      - "${NETWORK_PORT:-2024}:2024"       # Gravity Network
      - "${INSPECTION_PORT:-10000}:10000"  # Inspection Service
    
    # 网络配置
    networks:
      - gravity_network
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8545", "-X", "POST", 
             "-H", "Content-Type: application/json",
             "-d", "{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":1}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# 网络
networks:
  gravity_network:
    name: gravity_network
    driver: bridge

# 数据卷 (仅在不指定外部路径时使用)
volumes:
  gravity_data:
    name: ${VOLUME_PREFIX:-gravity}_data
  gravity_logs:
    name: ${VOLUME_PREFIX:-gravity}_logs
  gravity_exec_logs:
    name: ${VOLUME_PREFIX:-gravity}_exec_logs
  gravity_consensus_log:
    name: ${VOLUME_PREFIX:-gravity}_consensus_log
